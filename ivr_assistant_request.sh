#!/bin/bash

# IVR Assistant API Request Script using curl
# Uses the exact URL and API key provided

API_URL="https://nexiva-etisalat-af-ai.openai.azure.com/openai/deployments/gpt-4.1-mini/chat/completions?api-version=2025-01-01-preview"
API_KEY="6JIUNO5wZzB7NX2DEj0vYbZ0N4YDkamrq68qqKOjFPAxLm98EkuBJQQJ99BIACF24PCXJ3w3AAABACOG4LvJ"

# User query and current node ID
USER_QUERY="Activate a package."
CURRENT_NODE_ID=5

# Create the JSON payload
PAYLOAD=$(cat <<EOF
{
  "messages": [
    {
      "role": "system",
      "content": "You are an IVR assistant system. Your job is to take in:\n\n•  A user_query: the latest user input (text/voice transcription)\n•  A current_node_id: the node the user is currently on\n•  A full IVR tree JSON containing:\n   ?  node_id: unique identifier\n   ?  stt: speech-to-text data for voice and dtmf prompts\n   ?  children: array of child node_ids\n\nYour task is to:\n\nReturn the output with node_id as follow the below json:\n\n1. Search the entire IVR tree (not limited to the children of current_node_id)\n2. Semantically compare the intent of the user_query to all voice and dtmf prompts. Use deep semantic understanding to interpret the user's intent from their query, considering nuances and context, rather than relying solely on keywords. When user query explicitly mentions a specific product or service, prioritize returning directly the corresponding detailed product node id.\n3. If user asks to directly take you to a certain node id number, return the -1 node id.\n4. Identify the node_id with the most relevant intent match. Check the prompt of current node id and then check the user query and then map it against the prompt of child of the current node id. If nothing matches then start from the start node.\n5. Low Confidence Detection:\nIf the system detects that the confidence level for intent matching is lower than a predefined threshold, 0.3 in our case, treat this as a low-confidence scenario where the user's intent is ambiguous.\nIn such cases, instead of returning a specific node, return \"node_id\": \"-1\", and provide a suitable fallback reason. For example:\n\"reason\": \"The user's intent seemed unclear or not fully aligned with the available options. Our IVR flow offers services such as appointment scheduling, general inquiries, or emergency assistance. However, the query provided doesn't match any of these options.\"\nSpecify user's query or intent as well in the reason field.\n6. If user asks to listen to the same menu or repeat the prompt again, return the current node id back.\n7. There are some prompts in the IVR flow where we are asking number input from the user like phone number or credit card number etc. You may get the number in the user query, extract it as it is and return in the response json in the parameter \"user_input\" as string along with a text confirming the user input in the parameter \"confirmation_message\". Keep these 2 fields always empty if the input is not detected. \"node_id\" will be the <<current_node_id>> in the response.\n8. In the above scenario, in which we got the input from the user, then it is expected in the next query of the user you will get the confirmation of the user against the input. Analyze user's intent to check whether the input is confirmed or not, and based on the intent set the value \"success\" or \"failure\" of \"input_confirmed\" in the response json. In other cases always keep it empty. \"node_id\" will be the <<current_node_id>> in the response. In case the user's answer to the confirmation is not affirmative, retry asking the user for that specific number once. If the user fails to confirm again, set the value of the input_confirmed field to \"failure\".\n9. You always have to check the user's previous and current query to analyze the intent more precisely. Like in cases, where the prompts end in \"would you like to know more\" or \"Please confirm your phone number <<user_input>>\". In both these cases you may get affirmation in many ways, get the intent and then give the response. Also the examples I have given in this point are of 2 very different scenarios, the first is the general case and the other is the user input case. Don't mix these cases and handle cases as you are told.\n10. Return the result in the following JSON format:\n{\n  \"node_id\": \"<string>\",\n  \"confidence\": <float between 0 and 1>,\n  \"matched_text\": \"<exact matched voice or dtmf prompt>\",\n  \"reason\": \"<Precise reasoning behind returning this specific node_id>\",\n  \"user_input\": \"<Only the number input from the user otherwise empty>\",\n  \"confirmation_message\": \"<Reply confirming the message if input is detected otherwise empty>\",\n  \"input_confirmed\": \"success/failure based on user confirmation after the input otherwise empty\"\n}"
    },
    {
      "role": "assistant",
      "content": ""
    },
    {
      "role": "user",
      "content": "{\"current_node_id\": $CURRENT_NODE_ID}\nIVR Configuration: {\"metadata\": {\"source_xml\": \"xml.xml\", \"total_nodes\": 58, \"root_nodes\": 12, \"total_connections\": 31, \"node_types\": {\"Unknown\": 2, \"Start\": 1, \"Navigation\": 15, \"Normal\": 1, \"DTMF\": 24, \"URL\": 1, \"GenericAPIActionHandler\": 2, \"Dialout\": 1, \"Check\": 6, \"Wait\": 1, \"Exit\": 2, \"Processing\": 2}}, \"language_selection\": {\"choose_language\": \"3\", \"setlanguage_children\": []}, \"nodes\": {\"3\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Baroya zaboni dari kalidayak the partosa Bella para duhamatani Pastry for English.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/Prompts/preferredlanguage_enUS.wav\"]}}, \"children\": [\"4\"]}, \"4\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Prevent your SIM card from being blocked. SIM card registration is mandatory by law. Please visit your nearest episode shop in your province and register your SIM card.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/0frompreferredlanguageuptomainmenu/0frompreferredlanguageuptomainmenu/2promotionalannouncement/english/english_01_enUS.wav\"]}}, \"children\": [\"56\"]}, \"5\": {\"stt\": {\"voice\": [\"Welcome to Eddie Salat, Afghanistan Customer Services. I'm Wiesel. How can I help you today?\"], \"dtmf\": [], \"original_filenames\": {\"voice\": [\"/data/filestore/services/template/Prompts/greeting_VOICEPROMPT_enUS.wav\"], \"dtmf\": []}}, \"children\": [\"9\"]}, \"9\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Press 1 for data bundles. Press 2 for voice bundles. Press 3 for mixed and other bundles. Press 4 for services. Press 5 for package and migration. Press 6 for balance inquiry. Press 7 for further assistance. Press 8 for DRM bundles deactivation. Press * to repeat the same information.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/0frompreferredlanguageuptomainmenu/4mainmenu/english/e6excludingmybestoffers_enUS.wav\"]}}, \"children\": [\"10\", \"35\"]}, \"10\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Press 1 for information and activation, press 2 for deactivation. Press * to repeat the same information or press hash to return to the previous menu.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/2databundles/1press1forinformationactivationpress2fordeactivation/english/e8_enUS.wav\"]}}, \"children\": [\"11\", \"11\", \"10\", \"9\"]}, \"11\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Press 1 for information and activation, press 2 for deactivation. Press * to repeat the same information or press hash to return to the previous menu.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/2databundles/1press1forinformationactivationpress2fordeactivation/english/e8_enUS.wav\"]}}, \"children\": [\"11\", \"53\"]}, \"17\": {\"stt\": {\"voice\": [], \"dtmf\": [\"This bundle will allow you to obtain minimum 500 MB and maximum up to 750 MB Internet data plus 5 minutes to its alert numbers for only 30 Afghani which will be valid for 24 hours. The bundle will be renewed after 24 hours if you have sufficient credit in your SIM and upon renewal you will receive only 500 MB Internet data +5. It is alert minutes.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/2databundles/4dailydatabundles/1informationactivation/english/2daily500mbsurpriseoffer30afndetails_01_enUS.wav\"]}}, \"children\": [\"33\", \"17\"]}, \"18\": {\"stt\": {\"voice\": [], \"dtmf\": [\"This bundle will allow you to obtain 300 MB Internet data +5. It is allowed minutes at only 20 afghani, which will be valid for 24 hours. The bundle will be renewed after 24 hours if you have sufficient credit in your SIM.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/2databundles/4dailydatabundles/1informationactivation/english/3daily300mb5onnetmins20afndetails_01_enUS.wav\"]}}, \"children\": [\"34\", \"18\"]}, \"35\": {\"stt\": {\"voice\": [], \"dtmf\": [\"The estimated date and time for solving the issue is.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/8furtherassistance/2pendingcomplaintsincasecustomerhaspendingcomplaints/english/ifthereispendingcomplaint_enUS.wav\"]}}, \"children\": [\"37\"]}, \"44\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Sorry, error occurred.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/Prompts/service_activation_error_enUS.wav\"]}}, \"children\": [\"50\"]}, \"45\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Successfully deactivated.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/Prompts/service_deactivation_success_enUS.wav\"]}}, \"children\": [\"50\"]}, \"53\": {\"stt\": {\"voice\": [], \"dtmf\": [\"Press 1 for hourly and two hour bundles. Press 2 for daily. Press 3 for two days and three days bundles. Press 4 for weekly. Press 5 for 15 days bundles. Press 6 for monthly. Press 7 for night offers. Press 8 for social bundles. Press * to repeat the same information or press hash to return to the previous menu.\", \"Press 14500 MB surprise offer at 30 Afghani. Press 2 for 300 MB. At 20 Afghani, press 3 for 200 MB. At 15 Afghani, Press 4 for 1GB at 50 of Gaming, Press 5 for 2GB. At 77 Afghani. Press 6 for three GB at 90 Afghani. Press Start to repeat the same information or press hash to return to the previous menu.\"], \"original_filenames\": {\"voice\": [], \"dtmf\": [\"/data/filestore/services/template/divraudiofiles/2databundles/2press1forhourlypress8forsocialbundles/english/e9_enUS.wav\", \"/data/filestore/services/template/divraudiofiles/2databundles/4dailydatabundles/1informationactivation/english/1press1for500mbsurpriseoffer30afnpress6for3gb90afn_01_01_enUS.wav\"]}}, \"children\": [\"18\", \"17\"]}}}\nUse this additional Information to answer User query and treat it as HIGH PRIORITY.\nAdditional Info - User query: \"$USER_QUERY\""
    }
  ],
  "max_tokens": 500,
  "temperature": 0.3,
  "top_p": 1,
  "n": 1,
  "stream": false
}
EOF
)

echo "Making IVR request for user query: '$USER_QUERY'"
echo "Current node ID: $CURRENT_NODE_ID"
echo "----------------------------------------"

# Make the curl request
curl -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -H "api-key: $API_KEY" \
  -d "$PAYLOAD" \
  | jq '.' 2>/dev/null || cat

echo ""
echo "Request completed."
